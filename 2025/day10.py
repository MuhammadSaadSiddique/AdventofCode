import re
import itertools
import math
from fractions import Fraction
import re
import itertools

def solve_factory_machines(puzzle_input):
    lines = [line.strip() for line in puzzle_input.split('\n') if line.strip()]
    total_presses = 0
    
    print(f"Analyzing {len(lines)} machines...")

    for i, line in enumerate(lines):
        # Parse logic
        # format: [.##.] (3) (1,3) ... {3,5...}
        
        # 1. Extract Target Pattern
        target_match = re.search(r'\[([.#]+)\]', line)
        if not target_match:
            print(f"Skipping malformed line {i+1}")
            continue
            
        target_str = target_match.group(1)
        num_lights = len(target_str)
        
        # Convert target to integer bitmask (0 is first light)
        target_mask = 0
        for idx, char in enumerate(target_str):
            if char == '#':
                target_mask |= (1 << idx)
                
        # 2. Extract Buttons
        # Find all groups in parentheses
        button_matches = re.findall(r'\(([\d,]+)\)', line)
        buttons = []
        
        for b_str in button_matches:
            b_mask = 0
            indices = [int(x) for x in b_str.split(',')]
            for idx in indices:
                if idx < num_lights:
                    b_mask |= (1 << idx)
            buttons.append(b_mask)
            
        # 3. Solve for Minimum Presses
        # Since operations are XOR (modulo 2 addition), pressing a button twice undoes the action.
        # We only need to check combinations where each button is pressed 0 or 1 time.
        # We want the combination with the fewest number of 1s (presses).
        
        num_buttons = len(buttons)
        best_presses = None
        
        # Optimization:
        # If num_buttons is small (< 22), we can iterate 2^N.
        # Most puzzles of this type have small button counts.
        
        found = False
        
        # We iterate by number of presses (r) to find the minimum first (BFS effectively)
        for r in range(num_buttons + 1):
            for combo in itertools.combinations(buttons, r):
                # Calculate resultant state
                current_state = 0
                for b_mask in combo:
                    current_state ^= b_mask
                
                if current_state == target_mask:
                    best_presses = r
                    found = True
                    break
            if found:
                break
        
        if found:
            # print(f"Machine {i+1}: Solved with {best_presses} presses.")
            total_presses += best_presses
        else:
            print(f"Machine {i+1}: Impossible to solve.")
            
    return total_presses

def solve_linear_system_min_sum(matrix, target):
    """
    Solves Ax = b for non-negative integers x, minimizing sum(x).
    matrix: list of lists (columns are buttons, rows are counters)
    target: list of targets for each counter
    """
    if not matrix:
        return None
        
    num_vars = len(matrix)
    num_eqs = len(target)
    
    # Transpose matrix to standard Ax=b form (rows=eqs, cols=vars)
    # The input 'matrix' is a list of buttons (columns).
    A = [[Fraction(matrix[c][r]) for c in range(num_vars)] for r in range(num_eqs)]
    b = [Fraction(x) for x in target]
    
    # Augment matrix
    for r in range(num_eqs):
        A[r].append(b[r])
        
    # Gaussian Elimination to RREF
    pivot_cols = []
    free_cols = []
    
    curr_row = 0
    
    for c in range(num_vars):
        if curr_row >= num_eqs:
            free_cols.append(c)
            continue
            
        # Find pivot
        pivot_row = -1
        for r in range(curr_row, num_eqs):
            if A[r][c] != 0:
                pivot_row = r
                break
                
        if pivot_row == -1:
            free_cols.append(c)
            continue
            
        # Swap rows
        A[curr_row], A[pivot_row] = A[pivot_row], A[curr_row]
        
        # Normalize pivot row
        pivot_val = A[curr_row][c]
        for j in range(c, num_vars + 1):
            A[curr_row][j] /= pivot_val
            
        # Eliminate other rows
        for r in range(num_eqs):
            if r != curr_row and A[r][c] != 0:
                factor = A[r][c]
                for j in range(c, num_vars + 1):
                    A[r][j] -= factor * A[curr_row][j]
                    
        pivot_cols.append(c)
        curr_row += 1
        
    # Check consistency of remaining rows (0 = non-zero)
    for r in range(curr_row, num_eqs):
        if A[r][num_vars] != 0:
            return None # Inconsistent system
            
    # Bounds for search:
    # A safe upper bound for any variable is the max target value (assuming positive coeffs).
    bounds = []
    for j in range(num_vars):
        limit = float('inf')
        col_vec = matrix[j]
        has_constraint = False
        for i, val in enumerate(col_vec):
            if val > 0:
                limit = min(limit, target[i])
                has_constraint = True
        
        if not has_constraint:
            # If a button does nothing, strictly speaking we should never press it to minimize presses
            limit = 0 
            
        bounds.append(limit)

    min_total_presses = float('inf')
    
    # If no free variables, just check the single solution
    if not free_cols:
        sol = []
        possible = True
        # Reconstruct x vector
        x_vec = [0] * num_vars
        
        for i, p_col in enumerate(pivot_cols):
            val = A[i][num_vars]
            if val < 0 or val.denominator != 1:
                possible = False
                break
            x_vec[p_col] = int(val)
            
        if possible:
            return sum(x_vec)
        return None

    # If there are free variables, iterate them
    free_var_ranges = [range(int(bounds[c]) + 1) for c in free_cols]
    
    # Optimization: Sort free vars by bounds size to fail fast if huge? 
    # Or just iterate. With typical puzzles, this is okay.
    
    for free_vals in itertools.product(*free_var_ranges):
        current_presses = sum(free_vals)
        possible = True
        
        # Calculate pivots
        # The pivot equation is: x_pivot + sum(coeff * x_free) = constant
        # x_pivot = constant - sum(coeff * x_free)
        
        for i, p_col in enumerate(pivot_cols):
            val = A[i][num_vars]
            
            for k, f_col in enumerate(free_cols):
                coeff = A[i][f_col]
                if coeff != 0:
                    val -= coeff * free_vals[k]
            
            # Check if pivot variable is valid non-negative integer
            if val < 0 or val.denominator != 1:
                possible = False
                break
            current_presses += int(val)
            
            if current_presses >= min_total_presses:
                possible = False # Optimization: Prune if already worse
                break
            
        if possible:
            min_total_presses = min(min_total_presses, current_presses)
            
    return min_total_presses if min_total_presses != float('inf') else None


def solve_factory_machinesp2(puzzle_input):
    lines = [line.strip() for line in puzzle_input.split('\n') if line.strip()]
    total_presses = 0
    failed_machines = 0
    
    print(f"Analyzing {len(lines)} machines for Joltage Requirements...")

    for i, line in enumerate(lines):
        # 1. Extract Joltage Targets {3,5,4,7}
        joltage_match = re.search(r'\{([\d,]+)\}', line)
        if not joltage_match:
            print(f"Skipping line {i+1}: No joltage targets found.")
            continue
            
        target_vals = [int(x) for x in joltage_match.group(1).split(',')]
        num_counters = len(target_vals)
        
        # 2. Extract Buttons
        # Find all groups in parentheses, allowing for spaces
        button_matches = re.findall(r'\(([\d,\s]+)\)', line)
        buttons = []
        
        for b_str in button_matches:
            # Create a column vector for this button
            indices = [int(x.strip()) for x in b_str.split(',') if x.strip()]
            b_vec = [0] * num_counters
            for idx in indices:
                if idx < num_counters:
                    b_vec[idx] = 1
            buttons.append(b_vec)
            
        # 3. Solve System
        result = solve_linear_system_min_sum(buttons, target_vals)
        
        if result is not None:
            # print(f"Machine {i+1}: Solved with {result} presses.")
            total_presses += result
        else:
            print(f"Machine {i+1}: Impossible to solve.")
            failed_machines += 1
            
    if failed_machines > 0:
        return f"Partial Sum: {total_presses} (Warning: {failed_machines} machines were impossible)"
    return total_presses

# --- Input Area ---
puzzle_input = """[.###.#..] (0,2,3,4,6,7) (1,2,4,5,6) (1,3,4,5,7) (0,2,4) (4,7) (0,1,4,6) (1,2,3,4,5,7) (2,4,7) {29,44,42,26,66,27,30,36}
[###.#...] (3,4,6) (1,2,3,4,5,7) (0,1,2,4) (0,1,3,5,7) (0,1,4,5,6,7) (0,2,7) (4,6) (7) (0,6) (1,4,5,6,7) {214,221,33,36,226,204,203,217}
[##.#.###] (0,1,7) (2,3,4,5,6,7) (0,3,4,5,6,7) (0,1,3,5,6,7) (2,7) (0,1,2,3,4,6,7) (0,1,3,4,6,7) {68,52,32,65,52,36,65,88}
[.#.#...#..] (0,1,4,5,9) (0,2,6,7,8,9) (0,5,6,9) (2,5,6) (1,5,9) (0,1,3,4,6,7,8,9) (2) (0,1,2,3,4,6,8) (0,7,8,9) (0,1,3,5,6,7,9) (3,5,9) {68,64,220,49,46,43,59,35,36,57}
[##.#..#] (0,2,3,4) (2,3,5) (0,1,3,6) (0,1,3,4,5) (0,1,5,6) (5) {26,16,194,197,13,205,13}
[.##.....##] (0,1,4,7,8,9) (1,3,4,5,6,9) (2,4,9) (3,6,8) (0,2,3,4,6,7,8) (0,1,2,3,4,5,6,8) (1,2,3,4,6,7,8,9) (2,4,6,9) (0,1,5,8,9) (2,7) (4,6,8,9) (1,3,4,5,7,8,9) (1,3,4,6,7,8,9) {12,56,55,72,88,16,88,57,85,79}
[#...#] (0,2,3,4) (2,3) (0,1,2,3) (0,1,2) {27,21,43,41,6}
[#.###] (0,1,3) (1,2,3,4) (1,2,4) {4,29,25,14,25}
[#....##.#.] (5,6,8) (0,2,5,6,7,9) (1,3,5,6,7,9) (1,2,7,9) (1,2,4,5,6,7,8,9) (2,8) (0,2,3,5,6,7,8,9) (0,4,5,9) (4,5,8) (4,5) (0,2,3,4,5,7,8,9) (0) (1,2,3,4,5,6,7,8) {49,233,86,233,57,297,253,271,72,271}
[.#.##.] (0,2,4) (1) (3,4) (0,1,3,4,5) (0,1,2,5) (1,2) {42,46,35,25,35,32}
[..#.#] (0,3) (1,2,4) (1,2) (1,2,3,4) (0,2) (1,4) (2,3,4) {15,32,19,17,21}
[..##...] (0,1,2,5,6) (1,2,4,6) (0,1,3,5,6) (0,5) (1,3,5,6) (0,1,2,3,4,6) (5,6) (4,5) {34,37,14,35,29,64,55}
[##..#] (0,1,2,4) (1,2,3,4) (0,2,3) {141,151,155,18,151}
[#.#.##] (0,3) (5) (0,1,3) (0,1,2,5) (0,1,2,4,5) (1,3,5) (0,1,2,4) (1,3,4,5) {53,66,23,56,32,52}
[###.] (0,2) (0,2,3) (2,3) (0,1) (3) {40,15,38,38}
[.#..#] (0,2,3,4) (0,1,3) (1,4) {30,21,12,30,15}
[####.] (0,1,4) (1,2,3) (2,3,4) (1,3) (0,3) {24,12,4,30,9}
[..#.#.#] (4,6) (2,5) (0,2) (0,1,2,3,6) (1,2,4,5,6) (0,2,3,4,6) (0,4) {45,16,57,23,49,23,43}
[...###] (1,2) (4,5) (0,3,4) (0,2,3,5) (0,1,2,5) {36,11,27,29,27,37}
[##.##..###] (3,5,6,7,8,9) (0,1,2,3,5,7,9) (0,5,8) (2,4,5,8) (2,3,6,7) (0,1,2,3,6,7,8) (0,1,2,4,5,6,8) (5,6,7) {55,54,73,53,39,97,75,73,75,37}
[..##.#] (0,1,3,5) (0) (1,2,5) (3,4) (0,1,3,4) (1,2,3,5) (3,5) (0,1,5) {67,69,19,60,37,51}
[.#...##.##] (0,1,2,5,7,8) (1,5,6,8,9) (0,1,2,6,8) (0,8,9) (0,7) (1,9) (1,3,8) (1,5,7) (0,1,2,3,4,7,8) {39,69,24,40,20,11,6,28,62,36}
[...###.#] (0,2,3,6) (0,1,3,4,5,6,7) (0,2,4,6) (0,1,2,3,6) (3,4,5,7) (1,3,4,6,7) {56,33,48,55,29,11,63,18}
[.#..#] (1,2,4) (2,3) (0) (1,4) (3) (3,4) (0,1,2) {23,28,26,33,26}
[###.#.#] (0,2,3,4,6) (0,4,5,6) (3,4,5,6) (0,2) (1,4,5,6) {39,14,23,178,208,197,208}
[#.###.#] (1,2,4,5) (0,2,3,4) (1,2,3,5,6) (0,2) (0,1,3,6) (0,1,2,6) {151,134,151,33,11,11,134}
[......##] (0,1,2,4,6,7) (0,1,2,4,5) (0,2,3,4,5,7) (0,1,4,5,7) (0,1,2,3,6,7) (0,1,2) (6,7) (0,1,3,6) {91,80,63,32,60,42,50,65}
[..##.#.##] (0,2,5,7) (1,2,3,6,8) (0,1,4,6,7) (5,7,8) (0,1,3,4,6,7,8) (0,5) (3,5,7) (1,3,4,5,6) (2,3,4,8) (0,1,4,5,7) (0,1,3,5,6,8) {67,79,51,89,68,93,75,87,72}
[##..] (2) (0,3) (0,1,3) (0,1) {19,7,12,12}
[.#.#.] (0,1,4) (1,3) (0,2,3) (2,3,4) {29,25,205,214,208}
[###.#.##.] (0,1,2,5,6,7,8) (2,4,5,6) (1,3,4,5,6) (1,4,5,7,8) (0,2,3,5,6,7,8) (0,2,3,4,6) (0,3,4,8) (7) (0,2,5) {71,35,55,65,65,78,52,52,57}
[.....##...] (0,1,2,3,4,5,6,7) (9) (1,4,5,6,7,8,9) (0,1,3,4,8,9) (0,2,3,6,8) (0,2) (5,6,9) (1,3,4,6,8,9) (1,3,4,5,6,8,9) (0,1,2,3,5,6,8,9) (1,2,4,5,6,7,8,9) (0,5,8) (3,5,6,8) {48,77,30,85,62,82,99,11,99,107}
[.###..##.#] (1,2,3,4,5,6,8,9) (8,9) (0,1,2,3,5,8,9) (1,2,3,4,9) (0,1,3,4,5,7,8,9) (3,5,6,9) (1,2,3,5,6,7,9) (0,2,3,4,6,7,8,9) (0,2,3,6) (0,1,2,5,6) (1,3,4,5,7,8) (0,1,3,6,8,9) {46,82,72,101,68,70,60,45,62,95}
[##.#...] (3,4,5) (0,3,4,5) (0,1,2,5,6) (0,2) (2,3,4,6) (0,1,4,5) (1,2,5,6) (0,1,3) (0,3,4,5,6) {74,33,19,53,45,43,16}
[.....##.##] (7,9) (0,2,3,4,5,6,7,8) (1,3,4,5,6,7,8,9) (0,1,4,8) (2,6) (0,3,4,5,8) (3,4,5,7,8) (1,2,3,5,6,7,8) (0,3,4,6,7,8) (0,8) (1,2,3,4,6) {31,52,39,48,64,34,53,33,55,15}
[.##..####.] (0,3,4,6,9) (0,1,2,3,5,6,7,8,9) (3,4) (0,3,7,8,9) (0,1,2,5,6,7,9) (1,3,4,5,6,8,9) (4,7) (1,3,6,8,9) (0,1,2,3,4,5,8) (6,7) {61,32,27,62,56,32,35,41,36,52}
[#.........] (1,3,4,7) (1,4,5,7,8) (0,1,2,3,5,7,9) (4,5) (2,3,9) (0,1,2,3,6,7,8,9) (3,6,9) (0,1,4,6,7,8) (0,4,9) (1,2,3,6) (5,7,8,9) (6) {36,70,32,60,49,33,64,58,35,45}
[#..##.] (0,1,4) (1,2,4) (0,1,2,3) (1,5) {13,42,20,0,33,9}
[###...] (0,1,2) (1,2,4,5) (2,3,5) (1,3,5) (1) (1,2,3) {199,238,232,27,12,38}
[.#..#...#.] (1,8,9) (2,3) (1,2,4,6,7) (0,1,2,3,4,7,8) (1,2,3,5,6,7,8,9) (1,2,7) (1,2,7,9) (2,3,4,5,7,8,9) (1,3,5,6,7,9) (0,2,3,5,7,8,9) (0,2,3,4,6,8) {24,64,85,71,35,52,39,83,58,76}
[..#..#....] (5,7) (1,3,4,5,6,8) (0,2,3,4,5,6,7,9) (0,3,8) (1,2,3,4,6,8) (1,6,9) (1,2,3,4,7,8,9) (4,7) {18,42,20,51,52,30,24,53,50,29}
[#.####] (1,2) (0,1,4) (3,5) (1,4,5) {14,38,19,16,19,21}
[..#..#.#.#] (4,6) (1,2,3,5,6,8,9) (0) (0,1,3,4,5,6,8,9) (0,1,3,4,6,7,8) (0,1,5,7,8) (0,1,4,5,8) (3,4,7,8) (1,9) (0,1,2,3,5,8,9) (5,6,9) (4,6,8,9) (0,4,6,7) {48,63,17,57,51,161,167,30,61,173}
[.#..] (0,1) (0,2) (0,1,2) (1,3) {134,125,19,10}
[#..#...##] (0,1,2,4,5,6,7) (3,4,5,6,8) (0,3,4,5,6) (0,1,2,3,4,5,6,8) (1,4,5,8) (1,2,6,8) (2,8) (0,4,7,8) (0,2,5,6,7) (0,1,3,4,7) {239,250,225,234,253,237,241,31,232}
[..###] (1,2,3,4) (0,1,2) (0,4) (0,1,4) (2,3,4) {35,21,29,19,44}
[#####] (1,2) (0,1,3,4) (0,3,4) (2) (0,1,4) (3,4) {29,27,12,34,41}
[#.#.##.] (1,3,5,6) (0,2,3) (3,4,6) (0,2,4,5,6) (0,4) (2) (0,1,4,5,6) (2,3,4,5) (1,2,4,5,6) {43,21,73,41,62,61,42}
[##.###.] (0,1,2,5,6) (0,1,3,4,5) (0,1,3,4,6) (0,1,3,4,5,6) (0,2,3,4,5) (2,3,4) (3,4,5) (0,1,2) {187,167,59,174,174,180,143}
[..###] (0,2,3) (0,1,2,3,4) (1,2,3) (1,2) {178,17,195,184,0}
[#.#.####] (0,1,3,4,5) (1,2,4,5,6,7) (7) (0,2,4,5,6,7) (0,2,3,5,6,7) (2,4,5,6,7) (2,3) (1,2,3,5,6,7) {38,33,50,47,31,59,45,52}
[..#..#..#] (6,8) (1,2,5,6) (0,1,2,3,8) (2,4) (0,1,2,3,5,7,8) (0,2,3,6,7) (1,2,3,4,5,6,8) (0,1,2,3,4,5,6) (0,2,4) (0,1,2,4,6,7,8) (2,7) {67,69,126,63,55,49,64,35,34}
[.####.] (2,4,5) (1,2,3,4) (3) (0,2,3,5) (0,2,5) (0,3) (1,5) (0,3,4,5) {36,33,32,53,30,52}
[.#...##..] (1,2,3,4,7,8) (5,7) (0,1,3,4,8) (0,1,4) (1,2,3,5,6,8) (0,3,4,6,7,8) (0,2,4,5,7,8) (1,3,4,5,6,7,8) {47,39,35,53,61,58,43,67,70}
[##.#..#...] (0,1,2,4,9) (0,1,4,5,7) (0,1,2,4,5,6,7,8) (1,4,5,6,7,8,9) (0,1,3,6,8) (0,5,7) (2,5,9) (6,9) (0,3,4,6,8,9) (3,5,6,8,9) (2,3,9) {79,68,128,135,61,61,67,48,54,165}
[#...] (0,2) (1,3) (0,1) (1,2,3) (1) {17,26,20,18}
[.#.####.] (2,6) (0,2,5,6,7) (0,2,3,4,7) (1,3,6) (2,3,4,5) (1,2,3,4,5,7) (3,4,5,6,7) {21,32,60,55,38,55,63,48}
[#..###..#] (2,3,5,6) (0,3,6,7) (0,1,4) (0,3,4,5,6) (0,2,4,5,6,7,8) (0,1,4,6,7,8) (2,3,6,7) {58,32,44,52,42,29,80,60,28}
[..#.##..##] (0,4) (1,2,3,4,5,8,9) (0,9) (0,5,7) (1,5,7,8) (0,2,4,5,6,8,9) (5,6,8) (0,3,7) (1,2,6) (0,1,4,6,7,8,9) {45,24,17,12,35,31,38,31,46,36}
[#..#.#.] (2,4,6) (0,1,3,4) (1,3,5) (0,1,2,4,6) (0,3,4,5) (0,1,3,5,6) (0,1,3,6) (0,2,4) (2,3,4,6) {51,44,43,50,44,33,49}
[#..#] (1) (1,2,3) (1,3) (3) (2) (0,3) {16,13,7,48}
[##..#..] (0,4) (0,3,5,6) (1,2,5,6) (0,2,3,4,5,6) (0,3,4) {33,12,16,26,31,18,18}
[##..#.##] (1,4) (0,1,2,3,4,5) (1,6) (0,2,6) (0,6) (0,2,3,4,5,7) (0,2,4,6,7) (1,2,3,4,6,7) (3,4) {64,26,55,37,65,25,46,38}
[#..#.] (0,1,4) (0,2,3) (2) {16,7,16,9,7}
[..##.#] (1,3,4) (1) (0,5) (2,3,4,5) (2,3,5) {18,30,11,29,25,29}
[#....#] (1,3,4,5) (0,3) (3) (1,3,4) (0,1,2,4) (2,5) (1,2,3,4,5) {17,49,36,54,49,34}
[#....#.] (4,5) (1,3,4,5,6) (0,1,2,4,5,6) (3) (0,1,2,3,5) (1,4) (3,5) (0,1,3,6) {20,43,7,48,37,30,34}
[...##] (0,1,2) (0,1,4) (0,1,2,4) (0,1,2,3) {159,159,147,130,18}
[..##] (0,1,2) (0,2,3) (2,3) {19,12,20,8}
[..#.#] (0,1,2,3,4) (1,2,3) (0,2,3) (1,2) {25,33,49,41,9}
[.##.] (1,2,3) (0,1,3) (0,2,3) {14,7,19,20}
[#..#] (1,2,3) (2) (0) (0,1,2) {30,21,154,4}
[#.##.] (1,2,3) (0,2,3) (2) (2,4) (1,3,4) (0,1) (1,3) {20,44,45,64,18}
[#.#.#.] (0,5) (0,2,4) (1) (3,5) (0,1,2,3,5) {38,36,29,21,10,30}
[#..#.....] (0,3) (0,1,2,4) (3,4,5,6) (0,1,3,5,7,8) (1,4,7,8) (0,1,2,4,5,6) (2,4,6) (1,2,3,4,5,6) {34,55,52,36,75,39,47,17,17}
[.#.#] (1,3) (0,2) {4,1,4,1}
[#.#.#####] (0,1,2,3) (2,4,8) (2,6,7,8) (1,4,5,7) (5,8) (4,5,6,7,8) (8) (3,8) (2,4,6,7) (1,4,5) {20,27,40,20,25,38,27,32,64}
[###.##.#] (0,1,3,4,6) (0,5,6) (1,2,3,5,6,7) (3,4,5,7) (1,2,3,4,5,6,7) (1,2,3,4,6) (1,2,3,4,6,7) (0,1,3,5,6) (0,3,4,5,7) (3,4,7) {24,234,225,267,251,51,239,64}
[....###] (2,3,4,6) (1,2,3,4,5) (1,3,4,5) (0,1,4,6) (1,2,4,6) (0,1,2,4) (0,1,2,5,6) {25,48,46,31,43,36,39}
[##..##...] (0,2,3,4,5,6,7,8) (1,4) (0,2,7) (3,5,6) (0,1,3,5,6,7,8) (2,5,7) (1,8) (1,2,5,6,7,8) (1,2,3,4,5,6,7) (3) (7) {16,55,47,46,28,61,42,72,33}
[#..##.] (1,2,3,4,5) (0,1,2,5) (1,2,4,5) (2,3,4) (1) {9,50,42,14,33,33}
[..#.#.##..] (1,3,5,9) (6,7,8) (0,1,2,3,4,5,6) (3,7,8,9) (6,7) (3,4,6,7,9) (1,2,3,4,5) (3) (4,5,7,9) (1,3,8) (0,2,3,6,8,9) (1,2,5,7) {4,30,18,62,32,42,40,78,40,57}
[.##.###] (0,1,2,4,5,6) (3,4,5) (0,3,6) (2,3,4,5,6) (0,3,5,6) (1,4,5) {26,18,21,51,49,62,41}
[.#.#] (1,3) (0,1,3) (1,2) {9,22,6,16}
[......#] (0,2,4,5,6) (1,2,4,5,6) (2,3,4,5,6) (3,4) (0,2,3,4) (0,2,3,5) (1,3,4,6) {33,21,51,57,63,37,41}
[###.] (0,1,2) (1,3) {19,36,19,17}
[...##] (3,4) (1) (0,2,3,4) (1,2) {0,10,7,15,15}
[##...####] (0,1,3,4,5,7) (0,2,4,8) (6,7) (0,3,4,5,6,7,8) (0,2,3,4,6,7) (1,2,3,4,5,8) (0,1,2,3,6,7,8) {152,133,154,157,38,16,166,167,142}
[####] (0,1,2,3) (0,2) {25,7,25,7}
[..#..#.##.] (0,1,2,3,5,7,8,9) (0,1,2,4,5,6,7,8,9) (0,1,2,3,5,7,9) (3,4,6,7) (1,2,5,7,9) (1,2,5,6,7,8,9) (0,2,4,5,7,8) (1,2,4,5,6) {37,66,77,24,30,77,31,60,33,49}
[.#.#..] (0) (2,4) (1,3,4) (0,3,4,5) (1,4) (2,3,4) (0,1,2,5) {153,36,23,23,53,6}
[.####.#.#] (0,1,2,4,6,7) (0,4,5,6,7,8) (0,1,4,5,6,7,8) (0,6,8) (0,4,6,7) (1,2,3,4,8) (3,4,5,8) (0,1,3,4,7,8) (1,7,8) (1,8) {71,72,31,37,82,30,57,79,89}
[##.#.#...#] (1,2,5,9) (0,1,2,4,5,6,7,8) (0,2,3,4,5,7,8) (1,2,3) (0,2,3,4,6,8) (7,8) (0,2,5,6) (0,1,2,3,4,5,6,7) {48,27,65,47,37,40,29,195,200,0}
[#.##..##.] (0,1,2,5,6,8) (1,2,3,5,6,8) (0,1,3,4,5,7,8) (3,6,8) (1,4,5,6,8) (1,3,5,8) (1,6) (0,1,2,4,5,6,7,8) (1,2,5,6,7,8) {26,76,44,42,22,56,90,23,76}
[.#.##..#] (0,1,2,3,4,5,6) (1,2,3,4,6,7) (0,1,2,3,4,5) (0,2,5) (1,2,7) (0,1,3,4,5,6) {43,69,51,49,49,43,41,26}
[##...#.] (3,4) (0,1,2,6) (0,1,5) (1,2,3,5,6) (2,3,4,5,6) {170,184,27,29,15,181,27}
[#.##] (0,1) (0,1,3) (1,2) (2,3) {37,43,19,30}
[#.#.#.#.#.] (0,1,2,3,5,6,8,9) (1,4,6) (2,3,5,6,8) (5,7,9) (0,1,2,4,6,8,9) (6) (2,4,6,9) (0,1,2,3,4,7,9) (0,3,4,8) (4,7) (0,1,2,3,4,6,8,9) (0,4) (0,1,2,4,5,8,9) {95,75,106,66,112,74,104,28,92,101}
[.###.] (0) (0,2,3) (1,4) (1,3,4) (1,2,3,4) (0,3,4) {38,28,39,55,42}
[####..] (1,2,3) (0,3,5) (0,1,4) (0,3,4,5) (2,3) {30,23,40,67,22,27}
[.#..#.....] (0,2) (0,1,2,4,5,6,9) (0,2,3,6) (3,6,7) (0,1,2,3,4,5,6,8,9) (0,2,3,5,6,8,9) (1,9) (0,1,2,3,4,5,8,9) (1,3,4,5,6,8,9) (4,6) {77,42,77,59,47,38,87,16,23,48}
[#####] (0,1,3) (0,1,2,3) (0,1,2) (0,2,4) (1,2,3) {49,153,161,138,19}
[...#.] (1,2) (2,3,4) (0,2,3,4) (0,1,3,4) (1,2,4) (0,3,4) {30,35,44,46,62}
[.###.##.#] (3,5) (6,7) (0,6) (2,3,5,6,7) (0,2,3,4,5,6,7,8) (4,5,6,7) (2,7,8) (1,3,6,8) (2,4,5,6,7,8) {25,3,56,48,34,61,76,76,44}
[#..###] (2,4,5) (1,4,5) (0,3,5) (1,3) (0,2,3) (0,4,5) (0,1,2,3) {40,21,25,43,16,33}
[.#..#.] (1,4,5) (0,1,4) (2) (1,4) (1,3) (0,2,4,5) {13,35,11,11,32,23}
[...#] (0,2) (1,3) (0,2,3) {16,6,16,18}
[####.##.#] (0,1,3,6,7,8) (1,2,3,5,7) (0,4,6) (0,1,2,3,4,6) (3,5,7,8) (0,1,2,4,6,8) (6,8) (5,7) (1,3,5,7,8) (0,2,3,4,5,6,7) (0,2,3,4,5,7) {71,44,49,48,58,48,71,61,41}
[#.##..] (1,2,3,5) (0,1,4,5) (0,5) (0,3,5) (0,2,3) (3,4) {31,21,10,12,21,25}
[...#.#..] (4,7) (4,6,7) (3,5) (0,4,5,6,7) (1,2,4,5,7) (0,3,4,6) (0,2,5) (0,3,5,6) (1,4,5) (0,1,4,5,7) {50,39,28,43,64,89,35,40}
[..####.#] (1,2,3) (0,1,2,5) (0,1,5,6,7) (0,1,2,7) (4,7) (0,1,3,4,7) {57,57,23,20,30,18,14,63}
[.#.###.] (1,3,4,5) (0,1,2,4,6) (0,3,5) (2,3,4,6) (0,2,4) {207,19,200,30,219,28,2}
[#.###] (1,4) (0,2,3,4) (0,3) (0,1,2) (1,3,4) (1,2) (1,3) {39,51,35,43,41}
[#.##] (2) (1,3) (0,3) {11,11,1,22}
[..##] (0,2,3) (1,2) (1,3) (2,3) {4,21,20,39}
[#.#.#.] (1,2,4) (0,1,3,5) (0,1) (1,3,5) (0,4,5) (0,2,5) {46,67,19,32,20,41}
[#..#.#.#.] (5,7) (2,4,5,7) (1,2,3) (0,5,6) (2,4,7,8) (1,3,4,8) (0,1,3) (0,1,2,4,5,6,7) (0,2,4,6,8) (0,6,8) {72,60,71,47,78,69,58,67,63}
[..#.#..#] (2,7) (4) (1,4) (0,2,3) (3,4,6) (6) (5) (3,4,5,6,7) (0,4,6) (2,4,7) {15,4,8,28,53,29,54,21}
[...#] (2) (2,3) (1,3) (0,2) (0) (0,1) {22,25,31,26}
[#.#..##..] (0,1,3,4,5,6,8) (0,1,3,4,5,6,7,8) (1,2,6,8) (2,3,5,6,7) (0,1,3,4,7,8) (0,2,6) (2,3,4,5,7) (0,2,3,4,5,6,7,8) (0,2,5,6) {68,43,42,68,62,58,66,54,57}
[#.###] (1,2,4) (0,2,3) (2,4) (0,3) (2,3,4) {22,15,35,29,29}
[..###...] (1,7) (0,2) (0,1,2,3,6) (0,1,2,3,4,5,7) (1,2,4,5,6,7) (5,7) {38,22,39,18,12,16,8,19}
[..#...#] (0,3,4,5,6) (0,1,3,4,5) (0,2,3,5) (1,2) (0,1,2,3,6) (2,4) {30,18,24,30,18,16,25}
[#.##] (1,3) (0,1) (0,2) (2,3) (0,3) (0) {44,11,20,27}
[..##.##] (1,4,5,6) (2,3,4,6) (0,1,3,4,5) (0,4,5,6) (0,1,2,3,4) (0,3,4,6) (0,1,2,5,6) (0,2,4,5,6) {47,33,24,39,63,37,59}
[#####....] (5) (2,4,5,6) (0,1,2,8) (0,1,8) (1,6,7) (0,2,5,6,7,8) (0,1,2,3,4) (1,2,3,4,5,7) (0,5,7) (1,3,6,7) (0,1,3,4,5,6,7) {89,223,59,176,52,70,170,201,42}
[.##.#] (0,2,3) (0,1,3,4) (0,1,2,3) {40,32,27,40,13}
[..###.] (1,2) (0,1,5) (0,2,3,4) (0,3,4,5) {22,12,13,15,15,14}
[#####.] (1,3,5) (2,3,4) (1,2,3) (1,3,4,5) (0,1,3) (0,3,4) (0,4) {205,56,39,94,228,20}
[.##...##..] (0,1,3,5,7,9) (1,6,8,9) (0,1,2,3,4,5,6,7,8) (0,4) (0,2,8,9) (0,6) (1,2,3,7) (0,1,4,5,6,7,8,9) (1,2,5,6,7,8,9) (2,3,4,5,7) {101,86,80,62,74,80,76,91,81,75}
[###.#.#.] (0,1,2,4,5,6,7) (1,2,5,7) (0,1,2,6) (0,1,2,4,5,7) (2,4,5) (0,4,5,7) (0,1,3,4,5,6,7) {204,212,214,6,37,51,189,43}
[####.##] (1,2,4,6) (1,2,3,5) (0,2,3,4) (0,1,5,6) (2,3) {19,33,29,16,19,20,26}
[##.#####..] (0,1,2,3,4,5,6,8) (1,3,6) (0,1,2,3,5,6,7,8,9) (3,5,6,8) (0,1,3,5,6,8,9) (0,2,3,6,7,8,9) (0,1,2,3,4,5,7,8,9) (2,4,6,7,8) {21,157,35,172,31,36,189,27,56,13}
[####..#] (0,2,3) (0,2,5) (3,4) (0,1,2,3,5) (1,3,5,6) (2,4,5,6) (1,3,4,5,6) {14,30,15,49,28,33,20}
[..##.#..] (0,1,2,5,7) (0,1,3,6) (2,5) (2,3,5) (2,4,7) (0,7) (1,6) {14,156,40,4,18,22,155,31}
[#.....] (1,4,5) (1,4) (2,3,4,5) (4) (0,1) (0) (0,2,3,4) {32,47,15,15,58,19}
[#....#.##.] (0,1,2,3,4,5,7,9) (1,2,3,4,5,6,8,9) (0,1,3,4,5,6,8,9) (0,6) (0,2,3,4,5,6,7,8) (1,2,3,4,5,7,8) (1,7,9) (1,7) (0,1,6) (4,5,7) (4,7) (5) {31,64,39,56,83,86,40,74,55,39}
[...##.##] (1,2,4,5,6,7) (2,3,4,7) (1,4,5,6,7) (0,3,5,7) (1,3,4,6) (2,4) (1,7) (3,5,6) (1,3,4,5,7) {5,77,54,62,108,64,57,82}
[#####..#.#] (0,2,3,4,5,6,7,8,9) (1,2,3,5,9) (1,9) (6,9) (1,2,3,4,5,7,8,9) (0,1,6,9) (0,1,3,4,5,6,7) (0,1,2,3,5,6,9) (2,5,8,9) (4,5) (0,2,4,5,6,7,8,9) (7) {27,54,38,43,25,52,42,39,15,65}
[#...###] (1,2,3,6) (4,5) (0,4,5,6) (0,1,6) (1,3,5,6) (0,1,2,3) (0,6) (0,1,2,3,5) (0,2,3,5,6) {100,79,75,79,22,64,89}
[#.#.....] (0,1,4,5,6,7) (2,3,4,5,6,7) (4,5,6) (1,2,3,6) (0,1,5,6,7) (1,3,4,5,6) (0,3,5,6,7) (2,3,5,6,7) (0,2,3,7) (0,2,3,4,7) {44,37,41,44,53,78,83,69}
[#.##..#.#] (0,1,3) (5,8) (1,2,4,5) (0,6,7) (1,5,7) (0,1,7,8) (7,8) (0,2,5,6) (1,7) (1,2,4,5,7) (0,1,2,3,5,6,7) {60,59,41,21,14,46,32,65,31}
[#..##] (0) (1,3,4) (0,3) (2,4) (0,2) {26,15,24,20,27}
[.##.#.#.] (0,2,4,7) (1,2,3,4,5,7) (0,1,3,4,5,6) (3,5,6) (0,1,2,3,7) (0,1,3,5,7) (1,2,3,6) (1,7) {38,139,139,143,129,121,34,128}
[#.#.##..#.] (0,2,3,5) (4,8,9) (1,3,4,5,6,7,8,9) (1,2,3,5) (0,2,5,6,7) (4,8) (3,4,5,6,7,8) (0,3,9) (1,2,3,5,6,7) {29,20,42,53,45,61,35,35,45,16}
[#.####.#.#] (0,1,2,4,7) (0,1,2,4,6,7,8) (0,3,5) (0,1,2,3,7) (0,1,2,3,5,6,7,9) (2,4) (2,8) (1,2,7,8) (0,3,7) (1,5,7) (1,3,6,7,8,9) {60,64,75,44,45,25,39,67,34,23}
[###..#..#] (0,1,2,5,8) (0,1,4,5,6,7,8) (0,1,2,3,6,7,8) (0,1,3,4,5,7,8) (5,7,8) (1,2,4,8) (4,6) (0,6,7) {61,58,28,30,58,46,65,75,73}
[#.....] (0,2,5) (1,3) (2,3,4,5) (1,2) (0,1,5) (0,1,2,4) (0) (1,2,4,5) {195,178,197,20,171,62}
[##..] (0,1,3) (0,3) (1,2,3) (0,2) (2) (1,3) {27,27,35,41}
[#####.] (0,4) (1,2,4) (0,1,5) (3,4) {26,33,15,17,40,18}
[.##..#.#.] (4,6,7,8) (2,3,7) (0,4) (1,5,8) (1,4,5) (0,2,3,4,5,6,7,8) (0,2,3,4,6,7,8) (1,3,4,5,6,7,8) {34,41,25,44,90,60,63,63,67}
[#...] (0,2,3) (0,3) (1,2) (0,1,2) (0,2) {43,32,51,11}
[.#.#.#..#] (0,1,5,8) (2,4,6) (0,2,4,5,7,8) (1,2,7) (4,6,8) (0,1,5,6,7) (0,3,6,7,8) {61,48,177,18,169,43,186,58,59}
[..###] (0,1,2) (0,1,4) (1,2,3) (0,3,4) (2,3,4) (0,2,3) {29,204,216,217,9}
[.#.#.#..#.] (2,3,4,5,8,9) (0,1,3,5,7) (1,2,4,6,7,8) (1,2,3,4,5,6,8) (0,1,2,3,4,6,8,9) (1,3,5,6,7,8,9) (1,3,6,7) (0,1,5,6,7,9) (1,2,3,4,5,6,7,8) {22,190,45,193,45,65,185,170,64,50}
[#.##.] (0,1,3,4) (0,1,2) (1,2,3) (0,2,3) (3) (1,3) (2) {41,42,32,38,15}
[..#.##] (2,3,5) (0,1,5) (0,3,4,5) (1,2,4,5) (0,1,4,5) (5) (1,3,4) (1,4) {39,69,22,17,54,61}
[##..#.##] (1,2,3,5,6,7) (3,5,6,7) (0,1,2,3,4,6,7) (1,6,7) (0,2,4,7) (3,4) (1,3,4) (1,3,5,7) (0,1,2,3,4,6) {25,64,42,83,45,42,61,60}
[.##....#] (0,2,5,7) (0,1,2,3,5) (0,2,3,4,5) (0,1,4,5,6) (0,2,4,5,6) (3,6,7) (1,4,5,6,7) (0,2,3,4,5,7) {64,14,53,29,46,65,41,44}
[#......] (0,1,3,4,5,6) (1,4,6) (0,1,6) (0,1) (1,2,3,5) (1,3,4,5) (0,1,2,3,6) (0,1,3,4,5) {174,188,6,150,153,144,159}
[.##.##] (0,1,2,3,5) (0,5) (1,4,5) (0,2,5) (0,2,3,4) (1,3,5) {42,32,35,22,16,55}
[#.#....#] (0,2,7) (3,6,7) (2,4,6,7) (0,1,4,5,6) (1,2,4,5,7) (0,1,2,3,4) (1,5,7) {24,27,52,30,44,17,41,63}
[.##.##.#.] (0,1,2,3,4,7,8) (0,3,5,8) (1,2,4) (0,2,3,5,7,8) (0,1,2,4,5,6,7,8) (0,2,3) (1,3,4,5,6,7) {86,52,81,72,52,52,18,51,69}
[#.#.###.] (4,6) (1,2,3,4,5) (0,1,2,3,4,5,6) (0) (0,1,4,6) (3) (1,6) (1,5) (0,4,7) (0,2,3) {52,30,14,29,35,28,16,18}
[#.##] (1,3) (0,2,3) {8,9,8,17}
[#...##..#.] (0,1,2,4,6,8,9) (2,5,6,8,9) (1,3,8) (0,1,2,3,4,6,8,9) (0,4,5,8,9) (0,8) (0,1) (1,2,3,4,5,6,8,9) (4,5,7,9) {51,67,69,48,71,52,69,8,99,86}
[.####.##] (1,2,4,6) (1,2,3,7) (0,1,3,4,5,6,7) (0,2,3,4,6,7) (1,4,5,7) (0,2,3,4,5,7) (0,1,2,3,5) (0,2,3,5,6) (0,4) {70,55,72,63,71,45,60,45}
[...#] (1) (2) (0,1) (0,1,3) (1,3) {34,45,6,27}
[.#.####] (3,4,5) (0,1,4,5) (0,1,2,4,6) (2,5) (1,2,3,4,6) (0,1,3,6) {37,38,16,32,35,23,31}
[...#.#] (1,5) (0,1) (4) (0,1,4) (0,3,4) (0,1,2) (0,2,3,4) {44,43,25,20,25,19}
[#####.] (0,2,3,4) (0,1,3) (1,2,3,4,5) (0,1,2) (0,1,2,4,5) {159,24,154,146,144,7}
[.#..#] (1,2,3,4) (0,2,3,4) (1,2) (3,4) (0,4) (0,1) {27,23,36,29,31}
"""

if __name__ == "__main__":
    result = solve_factory_machines(puzzle_input)
    print(f"Total fewest button presses required: {result}")
    result2 = solve_factory_machinesp2(puzzle_input)
    print(f"Total fewest button presses required: {result2}")
